(function(d){d.fn.MapMe=function(e){var a=d.extend(true,{},{mapCanvas:"mapPane",pinCenter:true,trackLocation:true,trackingPeriod:false,trackingCircle:true,centerMarker:{},markerCluster:false,markerClusterOptions:{styles:[{height:53,width:53,url:"http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m1.png",textColor:"#000",textSize:16},{height:56,width:56,url:"http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m2.png",textColor:"#000", textSize:16},{height:66,width:66,url:"http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m3.png",textColor:"#000",textSize:16},{height:78,width:78,url:"http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m4.png",textColor:"#000",textSize:16},{height:90,width:90,url:"http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/images/m5.png",textColor:"#000",textSize:16}],minimumClusterSize:3},customPins:{myCustomPin:{pinImg:"img/pin.png", pinImgSize:[36,55],pinOrigin:[0,0],pinAnchor:[18,55],pinShape:{coord:[1,1,1,36,55,36,55,1],type:"poly"},pinShadow:"img/pin-shadow.png",pinShadowSize:[77,58],pinShadowOrigin:[0,0],pinShadowAnchor:[22,55]}},markers:[],mapOptions:{zoom:12,center:[80,80],mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:true,panControl:false,zoomControl:true,scaleControl:true,streetViewControl:true,overviewMapControl:true}},e);this.each(function(){a.mapOptions.center=new google.maps.LatLng(a.mapOptions.center[0], a.mapOptions.center[1]);var b=new google.maps.Map(document.getElementById(a.mapCanvas),a.mapOptions);if(a.trackLocation==true)d.fn.MapMe.getUserPosition(b,a);else if(a.pinCenter==true)b.centerMarker=d.fn.MapMe.addCentrePin(b,a,[a.mapOptions.center.Oa,a.mapOptions.center.Pa]);var c=d.fn.MapMe.setMarkers(b,a);a.markerCluster==true&&typeof MarkerClusterer!=="undefined"&&new MarkerClusterer(b,c,a.markerClusterOptions);a.trackLocation&&a.trackingPeriod&&setTimeout(function(){d.fn.MapMe.updateLocation(b, a)},a.trackingPeriod)});return this};d.fn.MapMe.getUserPosition=function(e,a){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){d.fn.MapMe.geoSuccess(e,a,[b.coords.latitude,b.coords.longitude])},function(){d.fn.MapMe.geoFailure()},{timeout:a.trackingPeriod}):google.gears?google.gears.factory.create("beta.geolocation").getCurrentPosition(function(b){d.fn.MapMe.geoSuccess(e,a,[b.latitude,b.longitude])},function(){d.fn.MapMe.geoFailure()},{timeout:a.trackingPeriod}):d.fn.MapMe.geoFailure()}; d.fn.MapMe.geoSuccess=function(e,a,b){var c=new google.maps.LatLng(b[0],b[1]);e.centerSet||e.setCenter(c);e.centerSet=true;if(a.pinCenter==true)e.centerMarker&&(e.centerMarker.setMap(null),e.centerOverlay.setMap(null)),a.trackLocation=true,a.centerMarker.lat=b[1],a.centerMarker.lng=b[0],e.centerMarker=d.fn.MapMe.addCentrePin(e,a,b)};d.fn.MapMe.geoFailure=function(){};d.fn.MapMe.updateLocation=function(e,a){d.fn.MapMe.getUserPosition(e,a);setTimeout(function(){d.fn.MapMe.updateLocation(e,a)},a.trackingPeriod)}; d.fn.MapMe.setMarkers=function(e,a){var b=a.markers,c=[];if(b.length>0)for(var g=0;g<b.length;g++){var f=b[g],h=b[g].infoWindow,i=b[g].pinEvent;if(b[g].pin)f=d.fn.MapMe.customPin(e,a,f);else var j=new google.maps.LatLng(f.lat,f.lng),f=new google.maps.Marker({position:j,map:e,title:f.title});h&&d.fn.MapMe.addInfoWindow(e,a,f,h);i&&d.fn.MapMe.addPinEvents(e,a,i,f);c.push(f)}return c};d.fn.MapMe.addCentrePin=function(e,a,b){var c;a.centerMarker.pin?(c={},c.lat=b[0],c.lng=b[1],c.title=a.centerMarker.title, c.pin=a.centerMarker.pin,c=d.fn.MapMe.customPin(e,a,c)):(c=new google.maps.Marker({position:new google.maps.LatLng(b[0],b[1]),title:a.centerMarker.title,map:e}),c.setMap(e));var g=a.centerMarker.infoWindow;g&&d.fn.MapMe.addInfoWindow(e,a,c,g);b={strokeColor:"#4d9cff",strokeOpacity:0.4,strokeWeight:2,fillColor:"#4d9cff",fillOpacity:0.15,map:e,center:new google.maps.LatLng(b[0],b[1]),radius:200};if(a.trackingCircle==true)e.centerOverlay=new google.maps.Circle(b);return c};d.fn.MapMe.customPin=function(e, a,b){var c=b.pin;a.customPins[c]||alert("custom pin has not been defined properly");var d=new google.maps.MarkerImage(a.customPins[c].pinImg,new google.maps.Size(a.customPins[c].pinImgSize[0],a.customPins[c].pinImgSize[1]),new google.maps.Point(a.customPins[c].pinOrigin[0],a.customPins[c].pinOrigin[1]),new google.maps.Point(a.customPins[c].pinAnchor[0],a.customPins[c].pinAnchor[1])),f=new google.maps.MarkerImage(a.customPins[c].pinShadow,new google.maps.Size(a.customPins[c].pinShadowSize[0],a.customPins[c].pinShadowSize[1]), new google.maps.Point(a.customPins[c].pinShadowOrigin[0],a.customPins[c].pinShadowOrigin[1]),new google.maps.Point(a.customPins[c].pinShadowAnchor[0],a.customPins[c].pinShadowAnchor[1]));(a=a.customPins[c].pinShape)||(a="");c=new google.maps.LatLng(b.lat,b.lng);return new google.maps.Marker({position:c,map:e,shadow:f,icon:d,shape:a,title:b.title})};d.fn.MapMe.addPinEvents=function(e,a,b,c){for(var d in b)google.maps.event.addListener(c,d,b[d])};d.fn.MapMe.addInfoWindow=function(d,a,b,c){c=new google.maps.InfoWindow({content:c}); google.maps.event.addListener(b,"click",function(){c.open(d,b)})}})(jQuery);